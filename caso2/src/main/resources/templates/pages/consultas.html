<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}"></head>
<body>
    <header th:replace="~{fragments/header :: header}"></header>
    
    <div class="container mt-4">
        <h2><i class="bi bi-search"></i> Consultas Avanzadas</h2>
        <hr>
        
        <!-- Estadísticas generales -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">Usuarios Activos</h5>
                        <p class="card-text display-4">[[${usuariosActivos}]]</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-secondary">
                    <div class="card-body">
                        <h5 class="card-title">Usuarios Inactivos</h5>
                        <p class="card-text display-4">[[${usuariosInactivos}]]</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h5 class="card-title">Total Usuarios</h5>
                        <p class="card-text display-4">[[${totalUsuarios}]]</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filtros de consulta -->
        <div class="row">
            <!-- Consulta por Rol -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-filter"></i> Filtrar por Rol
                    </div>
                    <div class="card-body">
                        <form th:action="@{/consultas/por-rol}" method="get">
                            <div class="input-group">
                                <select class="form-select" name="nombreRol" required>
                                    <option value="">Seleccione un rol...</option>
                                    <option th:each="rol : ${roles}" th:value="${rol.nombreRol}" 
                                            th:text="${rol.nombreRol}"></option>
                                </select>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Búsqueda por texto -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-search"></i> Búsqueda por Texto
                    </div>
                    <div class="card-body">
                        <form th:action="@{/consultas/buscar}" method="get">
                            <div class="input-group">
                                <input type="text" class="form-control" name="busqueda" 
                                       placeholder="Buscar por nombre, apellido o email..." required>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Consulta por rango de fechas -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-calendar-range"></i> Filtrar por Fecha de Creación
                    </div>
                    <div class="card-body">
                        <form th:action="@{/consultas/por-fechas}" method="get">
                            <div class="mb-2">
                                <label class="form-label">Fecha Inicio:</label>
                                <input type="datetime-local" class="form-control" name="fechaInicio" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Fecha Fin:</label>
                                <input type="datetime-local" class="form-control" name="fechaFin" required>
                            </div>
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Usuarios recientes -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-sort-down"></i> Usuarios Ordenados
                    </div>
                    <div class="card-body">
                        <a th:href="@{/consultas/recientes}" class="btn btn-info w-100">
                            <i class="bi bi-sort-numeric-down"></i> Ver por Fecha de Creación (Más recientes)
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resultados de la consulta -->
        <div th:if="${usuarios != null}" class="mt-4">
            <h4 class="mb-3">
                <i class="bi bi-table"></i> Resultados: <small class="text-muted">[[${tipoConsulta}]]</small>
            </h4>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre Completo</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Activo</th>
                            <th>Fecha Creación</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="usuario : ${usuarios}">
                            <td>[[${usuario.idUsuario}]]</td>
                            <td>[[${usuario.nombreUsuario + ' ' + usuario.apellidoUsuario}]]</td>
                            <td>[[${usuario.emailUsuario}]]</td>
                            <td>
                                <span class="badge" th:classappend="${usuario.rol.nombreRol == 'ADMIN' ? 'bg-danger' : 
                                       usuario.rol.nombreRol == 'PROFESOR' ? 'bg-primary' : 'bg-secondary'}">
    [[${usuario.rol.nombreRol}]]
</span>
                            </td>
                            <td>
                                <span th:if="${usuario.activo}" class="badge bg-success">Sí</span>
                                <span th:unless="${usuario.activo}" class="badge bg-secondary">No</span>
                            </td>
                            <td th:text="${#temporals.format(usuario.fechaCreacion, 'dd/MM/yyyy HH:mm')}"></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(usuarios)}">
                            <td colspan="6" class="text-center text-muted">No se encontraron resultados</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <footer th:replace="~{fragments/footer :: footer}"></footer>
</body>
</html>